from openai import OpenAI
import os

client = OpenAI(
    api_key="xx",
    base_url = "https://dashscope.aliyuncs.com/compatible-mode/v1",
)

user_prompt = "It has been 8246 minutes since you started trading. The current time is 2025-10-28 06:35:56.133912 and you've been invoked 3969 times. Below, we are providing you with a variety of state data, price data, and predictive signals so you can discover alpha. Below that is your current account information, value, performance, positions, etc.\n\n**ALL OF THE PRICE OR SIGNAL DATA BELOW IS ORDERED: OLDEST → NEWEST**\n\n**Timeframes note:** Unless stated otherwise in a section title, intraday series are provided at **3‑minute intervals**. If a coin uses a different interval, it is explicitly stated in that coin’s section.\n\n---\n\n### CURRENT MARKET STATE FOR ALL COINS\n\n### ALL BTC DATA\n\ncurrent_price = 113917.5, current_ema20 = 113800.1, current_macd = -0.606, current_rsi (7 period) = 69.42\n\nIn addition, here is the latest BTC open interest and funding rate for perps (the instrument you are trading):\n\nOpen Interest: Latest: 30034.57  Average: 30033.24\n\nFunding Rate: 1.25e-05\n\n**Intraday series (by minute, oldest → latest):**\n\nMid prices: [113704.0, 113793.0, 113812.0, 113791.0, 113770.0, 113824.0, 113807.5, 113830.5, 113817.5, 113917.5]\n\nEMA indicators (20‑period): [113761.454, 113767.791, 113773.716, 113774.029, 113771.836, 113776.804, 113782.251, 113786.227, 113788.11, 113800.1]\n\nMACD indicators: [-71.698, -57.321, -45.245, -39.496, -36.616, -28.119, -20.343, -14.817, -11.754, -0.606]\n\nRSI indicators (7‑Period): [46.398, 62.539, 62.745, 53.623, 49.505, 59.655, 60.911, 58.777, 54.748, 69.42]\n\nRSI indicators (14‑Period): [44.366, 53.604, 53.735, 49.748, 47.871, 53.208, 53.904, 53.054, 51.48, 59.284]\n\n**Longer‑term context (4‑hour timeframe):**\n\n20‑Period EMA: 113270.751 vs. 50‑Period EMA: 111846.432\n\n3‑Period ATR: 405.557 vs. 14‑Period ATR: 563.094\n\nCurrent Volume: 24.128 vs. Average Volume: 4681.536\n\nMACD indicators: [879.531, 952.494, 1071.557, 1196.822, 1319.057, 1385.035, 1392.784, 1374.607, 1278.65, 1172.385]\n\nRSI indicators (14‑Period): [69.527, 68.343, 72.131, 74.154, 75.771, 73.826, 70.125, 69.017, 60.852, 58.973]\n\n---\n\n### ALL ETH DATA\n\ncurrent_price = 4093.55, current_ema20 = 4082.46, current_macd = -1.929, current_rsi (7 period) = 77.036\n\nIn addition, here is the latest ETH open interest and funding rate for perps:\n\nOpen Interest: Latest: 516552.56  Average: 516605.44\n\nFunding Rate: 1.25e-05\n\n**Intraday series (3‑minute intervals, oldest → latest):**\n\nMid prices: [4075.35, 4078.3, 4077.2, 4078.6, 4080.1, 4081.0, 4081.1, 4084.0, 4083.2, 4093.55]\n\nEMA indicators (20‑period): [4082.573, 4082.119, 4081.755, 4081.483, 4081.218, 4081.016, 4081.234, 4081.488, 4081.508, 4082.46]\n\nMACD indicators: [-7.454, -6.921, -6.384, -5.843, -5.369, -4.904, -4.149, -3.462, -3.06, -1.929]\n\nRSI indicators (7‑Period): [32.471, 47.785, 49.38, 51.455, 50.648, 52.391, 66.77, 68.363, 56.732, 77.036]\n\nRSI indicators (14‑Period): [33.393, 40.95, 41.796, 42.855, 42.577, 43.368, 51.003, 51.999, 48.136, 61.761]\n\n**Longer‑term context (4‑hour timeframe):**\n\n20‑Period EMA: 4067.672 vs. 50‑Period EMA: 4004.813\n\n3‑Period ATR: 36.78 vs. 14‑Period ATR: 36.942\n\nCurrent Volume: 277.865 vs. Average Volume: 98452.589\n\nMACD indicators: [29.264, 34.768, 46.0, 58.081, 66.7, 69.399, 71.983, 74.032, 69.154, 62.574]\n\nRSI indicators (14‑Period): [67.436, 66.256, 73.095, 75.839, 75.439, 68.466, 69.623, 70.407, 59.392, 56.09]\n\n---\n\n### ALL SOL DATA\n\ncurrent_price = 199.505, current_ema20 = 199.414, current_macd = -0.383, current_rsi (7 period) = 58.329\n\nIn addition, here is the latest SOL open interest and funding rate for perps:\n\nOpen Interest: Latest: 3819367.38  Average: 3822048.75\n\nFunding Rate: 1.25e-05\n\n**Intraday series (3‑minute intervals, oldest → latest):**\n\nSOL mid prices: [199.14, 199.33, 199.29, 199.27, 199.16, 199.23, 199.15, 199.09, 198.88, 199.505]\n\nEMA indicators (20‑period): [199.75, 199.713, 199.676, 199.64, 199.585, 199.538, 199.508, 199.469, 199.407, 199.414]\n\nMACD indicators: [-0.652, -0.605, -0.563, -0.528, -0.511, -0.491, -0.459, -0.439, -0.44, -0.383]\n\nRSI indicators (7‑Period): [36.593, 48.279, 47.263, 45.764, 38.028, 39.12, 46.293, 41.08, 31.442, 58.329]\n\nRSI indicators (14‑Period): [36.324, 42.04, 41.638, 41.073, 38.019, 38.467, 41.43, 39.537, 35.466, 48.839]\n\n**Longer‑term context (4‑hour timeframe):**\n\n20‑Period EMA: 197.399 vs. 50‑Period EMA: 194.23\n\n3‑Period ATR: 1.653 vs. 14‑Period ATR: 1.914\n\nCurrent Volume: 16799.98 vs. Average Volume: 779767.463\n\nMACD indicators: [2.16, 2.345, 2.541, 3.052, 3.246, 3.178, 3.091, 2.975, 2.76, 2.744]\n\nRSI indicators (14‑Period): [66.842, 65.095, 66.691, 73.259, 66.971, 60.919, 60.952, 60.566, 57.378, 61.752]\n\n---\n\n### ALL BNB DATA\n\ncurrent_price = 1126.75, current_ema20 = 1127.26, current_macd = -2.296, current_rsi (7 period) = 65.126\n\nIn addition, here is the latest BNB open interest and funding rate for perps:\n\nOpen Interest: Latest: 74529.75  Average: 74586.53\n\nFunding Rate: -1.80752e-05\n\n**Intraday series (3‑minute intervals, oldest → latest):**\n\nBNB mid prices: [1124.75, 1125.35, 1124.9, 1124.9, 1124.6, 1125.65, 1125.7, 1126.5, 1126.65, 1126.75]\n\nEMA indicators (20‑period): [1129.08, 1128.72, 1128.385, 1128.034, 1127.669, 1127.453, 1127.324, 1127.265, 1127.182, 1127.26]\n\nMACD indicators: [-4.502, -4.283, -4.07, -3.897, -3.757, -3.508, -3.218, -2.906, -2.652, -2.296]\n\nRSI indicators (7‑Period): [36.272, 41.835, 41.309, 38.487, 35.646, 46.669, 52.236, 56.752, 53.786, 65.126]\n\nRSI indicators (14‑Period): [33.566, 36.498, 36.283, 35.164, 34.035, 39.092, 41.891, 44.256, 43.307, 49.523]\n\n**Longer‑term context (4‑hour timeframe):**\n\n20‑Period EMA: 1133.656 vs. 50‑Period EMA: 1124.972\n\n3‑Period ATR: 8.677 vs. 14‑Period ATR: 11.543\n\nCurrent Volume: 49.701 vs. Average Volume: 8737.791\n\nMACD indicators: [6.618, 6.623, 7.509, 8.971, 10.644, 13.828, 13.19, 12.508, 11.304, 10.192]\n\nRSI indicators (14‑Period): [59.055, 55.479, 59.844, 63.299, 65.649, 71.802, 55.755, 55.611, 53.179, 52.989]\n\n---\n\n### ALL XRP DATA\n\ncurrent_price = 2.62485, current_ema20 = 2.621, current_macd = -0.003, current_rsi (7 period) = 58.66\n\nIn addition, here is the latest XRP open interest and funding rate for perps:\n\nOpen Interest: Latest: 52862196.0  Average: 53289507.2\n\nFunding Rate: 3.8461e-06\n\n**Intraday series (3‑minute intervals, oldest → latest):**\n\nXRP mid prices: [2.619, 2.622, 2.62, 2.622, 2.618, 2.619, 2.617, 2.616, 2.616, 2.62485]\n\nEMA indicators (20‑period): [2.625, 2.625, 2.624, 2.624, 2.623, 2.623, 2.622, 2.622, 2.621, 2.621]\n\nMACD indicators: [-0.002, -0.002, -0.002, -0.002, -0.003, -0.003, -0.003, -0.003, -0.003, -0.003]\n\nRSI indicators (7‑Period): [27.842, 39.937, 38.812, 44.301, 31.228, 31.228, 41.088, 33.983, 30.983, 58.66]\n\nRSI indicators (14‑Period): [37.62, 42.519, 41.993, 44.223, 37.94, 37.94, 41.927, 38.589, 37.064, 50.703]\n\n**Longer‑term context (4‑hour timeframe):**\n\n20‑Period EMA: 2.599 vs. 50‑Period EMA: 2.535\n\n3‑Period ATR: 0.017 vs. 14‑Period ATR: 0.021\n\nCurrent Volume: 48997.0 vs. Average Volume: 8128112.792\n\nMACD indicators: [0.056, 0.055, 0.055, 0.054, 0.053, 0.05, 0.051, 0.051, 0.048, 0.045]\n\nRSI indicators (14‑Period): [73.684, 67.15, 70.443, 68.54, 67.236, 65.667, 71.103, 71.045, 62.099, 60.722]\n\n---\n\n### ALL DOGE DATA\n\ncurrent_price = 0.199235, current_ema20 = 0.199, current_macd = -0.0, current_rsi (7 period) = 70.65\n\nIn addition, here is the latest DOGE open interest and funding rate for perps:\n\nOpen Interest: Latest: 585551328.0  Average: 585572577.8\n\nFunding Rate: -4.1698e-06\n\n**Intraday series (3‑minute intervals, oldest → latest):**\n\nDOGE mid prices: [0.199, 0.199, 0.198, 0.199, 0.199, 0.199, 0.199, 0.199, 0.198, 0.199235]\n\nEMA indicators (20‑period): [0.199, 0.199, 0.199, 0.199, 0.199, 0.199, 0.199, 0.199, 0.199, 0.199]\n\nMACD indicators: [-0.0, -0.0, -0.0, -0.0, -0.0, -0.0, -0.0, -0.0, -0.0, -0.0]\n\nRSI indicators (7‑Period): [40.403, 38.55, 30.414, 38.714, 36.411, 42.766, 51.286, 49.152, 37.593, 70.65]\n\nRSI indicators (14‑Period): [40.448, 39.645, 35.818, 39.289, 38.276, 40.903, 44.704, 43.943, 39.372, 58.471]\n\n**Longer‑term context (4‑hour timeframe):**\n\n20‑Period EMA: 0.201 vs. 50‑Period EMA: 0.199\n\n3‑Period ATR: 0.001 vs. 14‑Period ATR: 0.002\n\nCurrent Volume: 359823.0 vs. Average Volume: 80655945.008\n\nMACD indicators: [0.001, 0.002, 0.002, 0.002, 0.003, 0.003, 0.002, 0.002, 0.002, 0.002]\n\nRSI indicators (14‑Period): [65.123, 61.369, 67.487, 69.524, 66.711, 58.597, 58.444, 57.825, 51.214, 48.921]\n\n### HERE IS YOUR ACCOUNT INFORMATION & PERFORMANCE\n\nCurrent Total Return (percent): -62.45%\n\nAvailable Cash: 1921.63\n\n**Current Account Value:** 3754.79\n\nCurrent live positions & performance: \n{'symbol': 'ETH', 'quantity': 1.38, 'entry_price': 4043.7, 'current_price': 4093.55, 'liquidation_price': 3855.06, 'unrealized_pnl': 68.79, 'leverage': 15, 'exit_plan': {'profit_target': 4265.0, 'stop_loss': 3920.0, 'invalidation_condition': '4-hour price closes below the 50-period EMA.'}, 'confidence': 0.65, 'risk_usd': 157.96, 'sl_oid': 212919606430, 'tp_oid': 212919574409, 'wait_for_fill': False, 'entry_oid': 212919521944, 'notional_usd': 5649.1}\n{'symbol': 'SOL', 'quantity': 14.79, 'entry_price': 202.81, 'current_price': 199.505, 'liquidation_price': 187.36, 'unrealized_pnl': -48.88, 'leverage': 10, 'exit_plan': {'profit_target': 222.997, 'stop_loss': 192.589, 'invalidation_condition': '4-hour price closes below the 50-period EMA.'}, 'confidence': 0.65, 'risk_usd': 149.95, 'sl_oid': 213403784979, 'tp_oid': 213403774503, 'wait_for_fill': False, 'entry_oid': 213403753516, 'notional_usd': 2950.68}\n{'symbol': 'XRP', 'quantity': 1862.0, 'entry_price': 2.6, 'current_price': 2.62485, 'liquidation_price': 2.49, 'unrealized_pnl': 52.42, 'leverage': 15, 'exit_plan': {'profit_target': 2.81055, 'stop_loss': 2.50787, 'invalidation_condition': '4-hour price closes below the 20-period EMA.'}, 'confidence': 0.65, 'risk_usd': 160.92, 'sl_oid': -1, 'tp_oid': -1, 'wait_for_fill': False, 'entry_oid': 212505584114, 'notional_usd': 4887.47}\n{'symbol': 'BTC', 'quantity': 0.05, 'entry_price': 115190.0, 'current_price': 113917.5, 'liquidation_price': 110878.25, 'unrealized_pnl': -63.62, 'leverage': 20, 'exit_plan': {'profit_target': 120007.53, 'stop_loss': 112152.48, 'invalidation_condition': '4-hour price closes below the 20-period EMA.'}, 'confidence': 0.62, 'risk_usd': 150.0, 'sl_oid': 214195044936, 'tp_oid': 214195014395, 'wait_for_fill': False, 'entry_oid': 214194990699, 'notional_usd': 5695.88}\n{'symbol': 'DOGE', 'quantity': -11294.0, 'entry_price': 0.2, 'current_price': 0.199235, 'liquidation_price': 0.21, 'unrealized_pnl': 7.17, 'leverage': 10, 'exit_plan': {'profit_target': 0.17975, 'stop_loss': 0.2097, 'invalidation_condition': '4-hour price closes back above the 20-period EMA.'}, 'confidence': 0.6, 'risk_usd': 112.72, 'sl_oid': 214596975970, 'tp_oid': 214596962503, 'wait_for_fill': False, 'entry_oid': 214596910648, 'notional_usd': 2250.16}\n{'symbol': 'BNB', 'quantity': -3.03, 'entry_price': 1123.5, 'current_price': 1126.75, 'liquidation_price': 1176.68, 'unrealized_pnl': -9.85, 'leverage': 10, 'exit_plan': {'profit_target': 1010.27, 'stop_loss': 1178.69, 'invalidation_condition': '4-hour price closes back above the 20-period EMA.'}, 'confidence': 0.65, 'risk_usd': 169.68, 'sl_oid': 214640194096, 'tp_oid': 214640171608, 'wait_for_fill': False, 'entry_oid': 214640126878, 'notional_usd': 3414.05}\n\nSharpe Ratio: -0.734"

messages = [
    {"role": "system", "content": "I'm Smart Thinking"},
    {"role": "user", "content": user_prompt}
]
completion = client.chat.completions.create(
    # 此处以 deepseek-v3.2-exp 为例，可按需更换模型名称为 deepseek-v3.1、deepseek-v3 或 deepseek-r1
    model="deepseek-v3.2-exp",
    messages=messages,
    # 通过 extra_body 设置 enable_thinking 开启思考模式，该参数仅对 deepseek-v3.2-exp 和 deepseek-v3.1 有效。deepseek-v3 和 deepseek-r1 设定不会报错
    extra_body={"enable_thinking": True},
    stream=True,
    stream_options={
        "include_usage": True
    },
)

reasoning_content = ""  # 完整思考过程
answer_content = ""  # 完整回复
is_answering = False  # 是否进入回复阶段
print("\n" + "=" * 20 + "思考过程" + "=" * 20 + "\n")

for chunk in completion:
    if not chunk.choices:
        print("\n" + "=" * 20 + "Token 消耗" + "=" * 20 + "\n")
        print(chunk.usage)
        continue

    delta = chunk.choices[0].delta

    # 只收集思考内容
    if hasattr(delta, "reasoning_content") and delta.reasoning_content is not None:
        if not is_answering:
            print(delta.reasoning_content, end="", flush=True)
        reasoning_content += delta.reasoning_content

    # 收到content，开始进行回复
    if hasattr(delta, "content") and delta.content:
        if not is_answering:
            print("\n" + "=" * 20 + "完整回复" + "=" * 20 + "\n")
            is_answering = True
        print(delta.content, end="", flush=True)
        answer_content += delta.content